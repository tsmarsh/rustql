#!/bin/bash
#
# Pre-commit hook for rustql
#
# Runs cargo fmt, clippy, and test before allowing commits.
# Install with: ./scripts/install-hooks.sh
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get the project root (where Cargo.toml lives)
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check if cargo is available
if ! command -v cargo &> /dev/null; then
    echo -e "${RED}Error: cargo not found. Please install Rust.${NC}"
    exit 1
fi

# Step 1: Check formatting
echo -e "\n${YELLOW}[1/3] Checking formatting (cargo fmt --check)...${NC}"
if ! cargo fmt --check 2>&1; then
    echo -e "${RED}Formatting check failed!${NC}"
    echo -e "Run '${YELLOW}cargo fmt${NC}' to fix formatting issues."
    exit 1
fi
echo -e "${GREEN}Formatting OK${NC}"

# Step 2: Run clippy (warn on issues, fail on errors)
echo -e "\n${YELLOW}[2/3] Running clippy (cargo clippy)...${NC}"
# Run clippy with default settings - fails on errors, warns on lint issues
if ! cargo clippy --all-targets --all-features 2>&1; then
    echo -e "${RED}Clippy found errors!${NC}"
    echo -e "Fix the issues above before committing."
    exit 1
fi
echo -e "${GREEN}Clippy OK${NC}"

# Step 3: Run tests
echo -e "\n${YELLOW}[3/3] Running tests (cargo test)...${NC}"
if ! cargo test 2>&1; then
    echo -e "${RED}Tests failed!${NC}"
    echo -e "Fix failing tests before committing."
    exit 1
fi
echo -e "${GREEN}Tests OK${NC}"

echo -e "\n${GREEN}All pre-commit checks passed!${NC}"

# Run SQLite compatibility tests in background (non-blocking, for tracking progress)
echo -e "\n${YELLOW}Starting SQLite compatibility tests in background...${NC}"
COMPAT_LOG="$REPO_ROOT/.compat-test-results.log"
(
    echo "=== SQLite Compatibility Test Run: $(date) ===" > "$COMPAT_LOG"
    cargo test --test sqlite_compat_test test_sqlite_compatibility_progress -- --ignored --nocapture >> "$COMPAT_LOG" 2>&1
    echo "" >> "$COMPAT_LOG"
    echo "=== Completed: $(date) ===" >> "$COMPAT_LOG"
) &
echo -e "Results will be written to: ${YELLOW}.compat-test-results.log${NC}"

exit 0
